--[[
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    MUSIC PLAYER SERVER
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    Author: ItoRenz00
    Place in: ServerScriptService
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
]]

local DataStoreService = game:GetService("DataStoreService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- CONFIGURATION
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

local CONFIG = {
    DATASTORE_NAME = "MusicPlayerData_v3",
    AUTOSAVE_INTERVAL = 180,
    MAX_CUSTOM_SONGS = 100,
    MAX_PLAYLISTS = 100,
    DEBUG_MODE = false,
    LOG_ERRORS_ONLY = true
}

local MusicDataStore = DataStoreService:GetDataStore(CONFIG.DATASTORE_NAME)
local playerDataCache = {}

local remoteEvent = ReplicatedStorage:FindFirstChild("MusicPlayerRemote")
if not remoteEvent then
    remoteEvent = Instance.new("RemoteEvent")
    remoteEvent.Name = "MusicPlayerRemote"
    remoteEvent.Parent = ReplicatedStorage
end

local remoteFunction = ReplicatedStorage:FindFirstChild("MusicPlayerFunction")
if not remoteFunction then
    remoteFunction = Instance.new("RemoteFunction")
    remoteFunction.Name = "MusicPlayerFunction"
    remoteFunction.Parent = ReplicatedStorage
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- UTILITY FUNCTIONS
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

local function debug_log(prefix, message)
    if CONFIG.DEBUG_MODE then
        print("[" .. prefix .. "] " .. message)
    end
end

local function error_log(prefix, message)
    if CONFIG.LOG_ERRORS_ONLY or CONFIG.DEBUG_MODE then
        warn("âŒ [" .. prefix .. "] " .. message)
    end
end

local function getDataKey(userId)
    return "Player_" .. tostring(userId)
end

local function validateSoundId(soundId)
    if not soundId or soundId == "" then
        return false, "Sound ID cannot be empty"
    end
    
    if not string.find(soundId, "rbxassetid://") then
        soundId = "rbxassetid://" .. soundId
    end
    
    local numStr = string.match(soundId, "rbxassetid://(%d+)")
    if not numStr or tonumber(numStr) == nil then
        return false, "Invalid Sound ID format"
    end
    
    return true, soundId
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- DEFAULT DATA STRUCTURE
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

local function getDefaultData()
    return {
        customSongs = {},
        playlists = {},
        favorites = {},
        settings = {
            volume = 5,
            autoPlayOnJoin = true,
            lastPlayedIndex = 1
        },
        stats = {
            totalSongsPlayed = 0,
            totalPlayTime = 0,
            lastModified = os.time(),
            createdAt = os.time()
        }
    }
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- DATA VALIDATION & SANITIZATION
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

local function sanitizeSettings(settings)
    if not settings or type(settings) ~= "table" then
        debug_log("SANITIZE", "Settings not table, using defaults")
        return {
            volume = 5,
            autoPlayOnJoin = true,
            lastPlayedIndex = 1
        }
    end
    
    local sanitized = {}
    
    sanitized.volume = settings.volume or 5
    if type(sanitized.volume) ~= "number" or sanitized.volume < 0 or sanitized.volume > 10 then
        sanitized.volume = 5
    end
    
    sanitized.autoPlayOnJoin = settings.autoPlayOnJoin
    if type(sanitized.autoPlayOnJoin) ~= "boolean" then
        sanitized.autoPlayOnJoin = true
    end
    
    sanitized.lastPlayedIndex = settings.lastPlayedIndex or 1
    if type(sanitized.lastPlayedIndex) ~= "number" or sanitized.lastPlayedIndex < 1 then
        sanitized.lastPlayedIndex = 1
    end
    
    debug_log("SANITIZE", "Settings sanitized - Volume: " .. sanitized.volume)
    
    return sanitized
end

local function validateSong(song)
    if type(song) ~= "table" then
        return false, "Song must be a table"
    end
    
    if not song.id or type(song.id) ~= "string" then
        return false, "Invalid song ID"
    end
    
    if not song.title or type(song.title) ~= "string" then
        return false, "Invalid song title"
    end
    
    if song.title:len() > 100 then
        return false, "Song title too long (max 100 chars)"
    end
    
    return true, "Valid"
end

local function validatePlaylist(playlist)
    if type(playlist) ~= "table" then
        return false, "Playlist must be a table"
    end
    
    if not playlist.name or type(playlist.name) ~= "string" then
        return false, "Invalid playlist name"
    end
    
    if playlist.name:len() > 50 then
        return false, "Playlist name too long (max 50 chars)"
    end
    
    if not playlist.songs or type(playlist.songs) ~= "table" then
        return false, "Invalid playlist songs"
    end
    
    for i, songId in ipairs(playlist.songs) do
        if type(songId) ~= "string" then
            return false, "Invalid song ID in playlist at index " .. i
        end
    end
    
    return true, "Valid"
end

local function validateData(data)
    if type(data) ~= "table" then
        return false, "Invalid data format"
    end
    
    if data.customSongs then
        if type(data.customSongs) ~= "table" then
            return false, "Invalid customSongs format"
        end
        
        if #data.customSongs > CONFIG.MAX_CUSTOM_SONGS then
            return false, "Too many custom songs (max: " .. CONFIG.MAX_CUSTOM_SONGS .. ")"
        end
        
        for i, song in ipairs(data.customSongs) do
            local valid, msg = validateSong(song)
            if not valid then
                return false, "Invalid song at index " .. i .. ": " .. msg
            end
        end
    end
    
    if data.playlists then
        if type(data.playlists) ~= "table" then
            return false, "Invalid playlists format"
        end
        
        if #data.playlists > CONFIG.MAX_PLAYLISTS then
            return false, "Too many playlists (max: " .. CONFIG.MAX_PLAYLISTS .. ")"
        end
        
        for i, playlist in ipairs(data.playlists) do
            local valid, msg = validatePlaylist(playlist)
            if not valid then
                return false, "Invalid playlist at index " .. i .. ": " .. msg
            end
        end
    end
    
    if data.favorites then
        if type(data.favorites) ~= "table" then
            return false, "Invalid favorites format"
        end
    end
    
    return true, "Data valid"
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- LOAD & SAVE FUNCTIONS
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

local function loadPlayerData(player)
    local userId = player.UserId
    local dataKey = getDataKey(userId)
    
    debug_log("LOAD", "Loading data for " .. player.Name)
    
    local success, result = pcall(function()
        return MusicDataStore:GetAsync(dataKey)
    end)
    
    if success and result then
        debug_log("LOAD", "Data found for " .. player.Name)
        
        local isValid, message = validateData(result)
        if isValid then
            result.settings = sanitizeSettings(result.settings)
            playerDataCache[userId] = result
            debug_log("LOAD", "Loaded music data for " .. player.Name)
            return result
        else
            error_log("LOAD", "Invalid data for " .. player.Name .. ": " .. message)
            playerDataCache[userId] = getDefaultData()
            return playerDataCache[userId]
        end
    elseif not success then
        error_log("LOAD", "Failed to load data for " .. player.Name .. ": " .. tostring(result))
    else
        debug_log("LOAD", "New player detected: " .. player.Name)
    end
    
    local defaultData = getDefaultData()
    playerDataCache[userId] = defaultData
    debug_log("LOAD", "New player data created for " .. player.Name)
    return defaultData
end

local function savePlayerData(player, data)
    local userId = player.UserId
    local dataKey = getDataKey(userId)
    
    data.settings = sanitizeSettings(data.settings)
    
    local isValid, message = validateData(data)
    if not isValid then
        error_log("SAVE", "Cannot save invalid data for " .. player.Name .. ": " .. message)
        pcall(function()
            remoteEvent:FireClient(player, "Error", "Invalid data: " .. message)
        end)
        return false
    end
    
    data.stats = data.stats or {}
    data.stats.lastModified = os.time()
    
    playerDataCache[userId] = data
    
    debug_log("SAVE", "Saving data for " .. player.Name)
    
    local maxRetries = 3
    for attempt = 1, maxRetries do
        local success, errorMsg = pcall(function()
            MusicDataStore:SetAsync(dataKey, data)
        end)
        
        if success then
            debug_log("SAVE", "Successfully saved for " .. player.Name)
            pcall(function()
                remoteEvent:FireClient(player, "SaveSuccess")
            end)
            return true
        elseif attempt < maxRetries then
            debug_log("SAVE", "Retry " .. attempt .. " for " .. player.Name)
            task.wait(1)
        else
            error_log("SAVE", "Failed to save data for " .. player.Name .. " after " .. maxRetries .. " attempts")
        end
    end
    
    pcall(function()
        remoteEvent:FireClient(player, "Error", "Failed to save data after retries")
    end)
    return false
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- PLAYER EVENT HANDLERS
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Players.PlayerAdded:Connect(function(player)
    debug_log("PLAYER", player.Name .. " joined")
    
    task.spawn(function()
        task.wait(1)
        local data = loadPlayerData(player)
        
        debug_log("SEND", "Sending data to " .. player.Name)
        
        pcall(function()
            remoteEvent:FireClient(player, "LoadData", data)
        end)
    end)
end)

Players.PlayerRemoving:Connect(function(player)
    debug_log("PLAYER", player.Name .. " leaving")
    
    local userId = player.UserId
    
    if playerDataCache[userId] then
        local success = pcall(function()
            local dataKey = getDataKey(userId)
            MusicDataStore:SetAsync(dataKey, playerDataCache[userId])
        end)
        
        if not success then
            error_log("SAVE", "Final save failed for " .. player.Name)
        else
            debug_log("SAVE", "Final save for " .. player.Name)
        end
        
        playerDataCache[userId] = nil
    end
end)

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- REMOTE EVENT HANDLER
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

remoteEvent.OnServerEvent:Connect(function(player, action, data)
    local userId = player.UserId
    
    if action == "LoadData" then
        local playerData = playerDataCache[userId] or loadPlayerData(player)
        debug_log("REQUEST", player.Name .. " requested LoadData")
        pcall(function()
            remoteEvent:FireClient(player, "LoadData", playerData)
        end)
        
    elseif action == "SaveData" then
        if data then
            savePlayerData(player, data)
        end
        
    elseif action == "AddSong" then
        local playerData = playerDataCache[userId] or loadPlayerData(player)
        if data and data.soundId and data.title then
            local isValid, validatedId = validateSoundId(data.soundId)
            if not isValid then
                pcall(function()
                    remoteEvent:FireClient(player, "Error", validatedId)
                end)
            else
                if not playerData.customSongs then
                    playerData.customSongs = {}
                end
                
                if #playerData.customSongs >= CONFIG.MAX_CUSTOM_SONGS then
                    pcall(function()
                        remoteEvent:FireClient(player, "Error", "Maximum custom songs reached: " .. CONFIG.MAX_CUSTOM_SONGS)
                    end)
                else
                    table.insert(playerData.customSongs, {
                        id = validatedId,
                        title = data.title:sub(1, 100),
                        addedAt = os.time()
                    })
                    
                    savePlayerData(player, playerData)
                    pcall(function()
                        remoteEvent:FireClient(player, "SongAdded", {id = validatedId, title = data.title})
                    end)
                    debug_log("ADD", "Song added for " .. player.Name .. ": " .. data.title)
                end
            end
        end
        
    elseif action == "RemoveSong" then
        local playerData = playerDataCache[userId] or loadPlayerData(player)
        if data and data.index then
            if playerData.customSongs and playerData.customSongs[data.index] then
                local removed = playerData.customSongs[data.index]
                table.remove(playerData.customSongs, data.index)
                savePlayerData(player, playerData)
                pcall(function()
                    remoteEvent:FireClient(player, "SongRemoved", {index = data.index})
                end)
                debug_log("REMOVE", "Song removed for " .. player.Name)
            else
                pcall(function()
                    remoteEvent:FireClient(player, "Error", "Song not found")
                end)
            end
        end
        
    elseif action == "ToggleFavorite" then
        local playerData = playerDataCache[userId] or loadPlayerData(player)
        if data and data.songId then
            if not playerData.favorites then
                playerData.favorites = {}
            end
            
            local index = table.find(playerData.favorites, data.songId)
            if index then
                table.remove(playerData.favorites, index)
                debug_log("FAV", "Removed favorite for " .. player.Name)
            else
                table.insert(playerData.favorites, data.songId)
                debug_log("FAV", "Added favorite for " .. player.Name)
            end
            
            savePlayerData(player, playerData)
            pcall(function()
                remoteEvent:FireClient(player, "FavoriteToggled", {songId = data.songId})
            end)
        end
        
    elseif action == "CreatePlaylist" then
        local playerData = playerDataCache[userId] or loadPlayerData(player)
        if data and data.name then
            if not playerData.playlists then
                playerData.playlists = {}
            end
            
            if #playerData.playlists >= CONFIG.MAX_PLAYLISTS then
                pcall(function()
                    remoteEvent:FireClient(player, "Error", "Maximum playlists reached: " .. CONFIG.MAX_PLAYLISTS)
                end)
            else
                table.insert(playerData.playlists, {
                    name = data.name:sub(1, 50),
                    songs = {},
                    createdAt = os.time()
                })
                
                savePlayerData(player, playerData)
                pcall(function()
                    remoteEvent:FireClient(player, "PlaylistCreated", {name = data.name})
                end)
                debug_log("PLAYLIST", "Created: " .. data.name .. " for " .. player.Name)
            end
        end
        
    elseif action == "AddToPlaylist" then
        local playerData = playerDataCache[userId] or loadPlayerData(player)
        if data and data.playlistIndex and data.songId then
            if playerData.playlists and playerData.playlists[data.playlistIndex] then
                local playlist = playerData.playlists[data.playlistIndex]
                if not table.find(playlist.songs, data.songId) then
                    table.insert(playlist.songs, data.songId)
                    savePlayerData(player, playerData)
                    pcall(function()
                        remoteEvent:FireClient(player, "AddedToPlaylist", {playlistIndex = data.playlistIndex})
                    end)
                end
            else
                pcall(function()
                    remoteEvent:FireClient(player, "Error", "Playlist not found")
                end)
            end
        end
    end
end)

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- REMOTE FUNCTION HANDLER
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

remoteFunction.OnServerInvoke = function(player, action, data)
    if action == "ValidateSoundId" then
        local isValid, result = validateSoundId(data)
        return isValid, result
    elseif action == "CheckSongExists" then
        local playerData = playerDataCache[player.UserId]
        if playerData and playerData.customSongs then
            for _, song in ipairs(playerData.customSongs) do
                if song.id == data then
                    return true
                end
            end
        end
        return false
    end
    return false, "Unknown request"
end

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- AUTO-SAVE SYSTEM
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

task.spawn(function()
    local autoSaveCount = 0
    while true do
        task.wait(CONFIG.AUTOSAVE_INTERVAL)
        
        autoSaveCount = autoSaveCount + 1
        local savedCount = 0
        
        for _, player in ipairs(Players:GetPlayers()) do
            local userId = player.UserId
            if playerDataCache[userId] then
                if savePlayerData(player, playerDataCache[userId]) then
                    savedCount = savedCount + 1
                end
            end
        end
        
        debug_log("AUTOSAVE", "Cycle #" .. autoSaveCount .. " - Saved " .. savedCount .. " players")
    end
end)

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- SHUTDOWN HANDLER
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

game:BindToClose(function()
    warn("ğŸ›‘ [SHUTDOWN] Server shutting down, saving all data...")
    
    for _, player in ipairs(Players:GetPlayers()) do
        local userId = player.UserId
        if playerDataCache[userId] then
            pcall(function()
                local dataKey = getDataKey(userId)
                MusicDataStore:SetAsync(dataKey, playerDataCache[userId])
            end)
        end
    end
    
    task.wait(2)
    warn("âœ… [SHUTDOWN] Shutdown save complete")
end)

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- INITIALIZATION
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
print("  âœ¨ MUSIC PLAYER SERVER âœ¨")
print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
print("ğŸ’¾ DataStore: " .. CONFIG.DATASTORE_NAME)
print("â° Auto-save: " .. CONFIG.AUTOSAVE_INTERVAL .. "s")
print("ğŸ”§ Debug: " .. (CONFIG.DEBUG_MODE and "ON" or "OFF"))
print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
